<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../css/wolai.css"/><title>Nest的框架特性 - wolai 笔记</title><link rel="shortcut icon"></link></head><body class="full-width"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="Nest的框架特性" class="main-title"></div></div></header><article><h1 id="bA2XbYDhCHuAZe3Z5FsRSk" class="wolai-block"><span class="inline-wrap">Nest<span class="jill"></span>的定位</span></h1><div id="2EAeJc9vhsmukzzQErCkoe" class="wolai-block wolai-text"><div><span class="inline-wrap">上一次介绍了<span class="jill"></span>nest<span class="jill"></span>的一些基础概念和入门用法，这次再聊聊<span class="jill"></span>nest<span class="jill"></span>作为目前最流行的<span class="jill"></span>node<span class="jill"></span>企业级开发框架，它有什么特点。</span></div></div><div id="oLuxjdYtoC2inP25ciHoeK" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="v19gdsDPdX4CZ3PHV6PT53" class="wolai-block wolai-text"><div><span class="inline-wrap">开发 node 应用有 3 个层次：</span></div></div><ul class="wolai-block"><li id="u8xna1ZG8WF5LPNy9pc6KJ"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">直接用 http、https 包的 createServer api</span></li><li id="gmvYFuqedgPUCr9qggErne"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">使用 express、koa 这种处理请求响应的库</span></li><li id="ig7Nxk3CSqC64Mpf8K4guP"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">使用 nest、egg、midway 这类企业级框架</span></li></ul><div id="55zWqZWL662Z2SCfvSdAqZ" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="fP5iKA3sBchBuMkqBVDCrw" class="wolai-block wolai-text"><div><span class="inline-wrap">1、直接用 createServer api 创建服务适合特别简单的场景，比如工具提供的开发服务。</span></div></div><div id="qgQfK5vCwtbJRsQqXC8qdf" class="wolai-block wolai-text"><div><span class="inline-wrap">2、express、koa 这种库并没有约束代码写法，开发者可以随意编写，所以不适合开发大型项目。</span></div></div><blockquote id="ukP8VDYV3xxwbsw9R4vYiG" class="wolai-block"><span class="gray inline-wrap">Express 理念是为 HTTP 服务器提供小型、强大的工具，使其成为单页应用程序、网站、混合或公共 HTTP API 的绝佳解决方案。而类似于<span class="jill"></span>express<span class="jill"></span>的还有其他，例如<span class="jill"></span>Koa、Hapi<span class="jill"></span>等。</span></blockquote><div id="eDUqBkJ8E7WXdvYLzcwiCz" class="wolai-block wolai-text"><div><span class="inline-wrap">3、大型项目会用企业级开发框架，有一定的代码约束，对很多功能都有开箱即用的解决方案的框架。</span></div></div><div id="NuyommMexGm2h4XPGUkAf" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="hsogJ2xjAQi3Xu6qG5n5JY" class="wolai-block wolai-text"><div><span class="inline-wrap">nest<span class="jill"></span>作为<span class="jill"></span>express<span class="jill"></span>的上层框架，目前已经有个<span class="jill"></span>57.3k Star，仅次于<span class="jill"></span>express 61.1k Star。虽然可以只用<span class="jill"></span>express<span class="jill"></span>来开发项目。同类的上层框架也有<span class="jill"></span>egg、midway。</span></div></div><div id="kBfKticUuLZK4TvC3R2miL" class="wolai-block wolai-text"><div><span class="inline-wrap">egg 的 ts 支持不好，在当下 ts 这么主流的情况下。（听说阿里 egg 团队也被打包裁了）</span></div></div><div id="wZUfGm5Rn9JamHfKLEWB37" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image.png" style="width: 631px"/></figure></div><div id="tyPeu8kXHUfZbDbK958KaC" class="wolai-block wolai-text"><div><span class="inline-wrap">而<span class="jill"></span>midway<span class="jill"></span>的<span class="jill"></span>Star<span class="jill"></span>仅有<span class="jill"></span>6.7k，少了一个数量级，很难保证不会步<span class="jill"></span>egg<span class="jill"></span>的路。</span></div></div><div id="8y7eip4DmemdVkP1Q3VtRX" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_1.png" style="width: 610px"/></figure></div><div id="tUcqA7VWFrMW3KyTctGEoM" class="wolai-block wolai-text"><div><span class="inline-wrap">综上来说，Nest<span class="jill"></span>目前对于企业级项目来说，是首选的，也几乎是唯一的。</span></div></div><div id="mcPv9rjuhDTTaVq4v2S4hA" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h1 id="3PdFGDs8P9t2oieAE9Wpv1" class="wolai-block"><span class="inline-wrap">Nest<span class="jill"></span>的设计</span></h1><div id="uxyiYZgCp9BihkQQL7xzzZ" class="wolai-block wolai-text"><div><span class="inline-wrap">nest<span class="jill"></span>的底层是</span><span class="inline-wrap"><b>基于但不限于</b></span><span class="inline-wrap">express<span class="jill"></span>的，它封装了<span class="jill"></span>IOC、AOP<span class="jill"></span>等架构特性；而这些特性都依赖于<span class="jill"></span>nest<span class="jill"></span>最主要的特性：</span><span class="inline-wrap"><b>模块机制</b></span><span class="inline-wrap">。</span></div></div><div id="xjREoEVvpvWjY8rG5HBJZM" class="wolai-block wolai-text"><div><span class="inline-wrap">看看<span class="jill"></span>es module<span class="jill"></span>的写法：</span></div></div><code-block id="4hW2zxFogiSGeJmuoF93AT" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> a<span class="token punctuation">,</span> b <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'a'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token exports"><span class="token punctuation">{</span> a<span class="token punctuation">,</span> c <span class="token punctuation">}</span></span><span class="token punctuation">;</span></pre></div></code-block><div id="kjikcn2GbdqagKMw2QzaxZ" class="wolai-block wolai-text"><div><span class="inline-wrap">而<span class="jill"></span>nest<span class="jill"></span>的<span class="jill"></span>module<span class="jill"></span>写法：</span></div></div><code-block id="dLvBYxYePAut1ccV5X7GX4" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> aModule <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./a.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">BService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./b.service'</span><span class="token punctuation">;</span>

@<span class="token function"><span class="token maybe-class-name">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">imports</span><span class="token operator">:</span> <span class="token punctuation">[</span>aModule<span class="token punctuation">]</span>
  <span class="token literal-property property">providers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">BService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">BService</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">BModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></pre></div></code-block><div id="rbMSZDHM13gPrV8QWrztb1" class="wolai-block wolai-text"><div><span class="inline-wrap">模块编写的逻辑上大同小异，都是<span class="jill"></span>import<span class="jill"></span>外部的值，可以<span class="jill"></span>export<span class="jill"></span>内部的值，而<span class="jill"></span>nest<span class="jill"></span>的模块机制是可以实现</span><span class="inline-wrap"><b>自动注入依赖</b></span><span class="inline-wrap">的，也就是 DI（Denpendency Injection）。</span></div></div><div id="kNmkDqZQYhmsJhMz4XtmWE" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="o6V16jXHgxjwEuopdnPhkH" class="wolai-block wolai-text"><div><span class="inline-wrap">怎么理解呢，在后端系统中，会有很多对象：</span></div></div><ul class="wolai-block"><li id="wZmjK2DwFC7NWgowPJ9xDT"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Controller 对象：接收 http 请求，调用 Service，返回响应</span></li><li id="eUMHQMePgQFvm1pcG1Vxhf"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Service 对象：实现业务逻辑</span></li><li id="kPcHKgLLtBhraQJdQ9KC5o"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Repository 对象：实现对数据库的增删改查</span></li></ul><div id="dVbSRW41QMf6UVDcQhQnBE" class="wolai-block wolai-text"><div><span class="inline-wrap">此外，还有数据库链接对象 DataSource，配置对象 Config 等等。</span></div></div><div id="fttjW2orykXHWY9DQ2usrn" class="wolai-block wolai-text"><div><span class="inline-wrap">这些对象有着错综复杂的关系：</span></div></div><aside id="oD6pq5nMB67KTezArT8EbK" class="bg-cultured wolai-block"><div data-symbol="📌" class="icon"></div><span class="inline-wrap">Controller 依赖了 Service 实现业务逻辑，Service 依赖了 Repository 来做增删改查，Repository 依赖 DataSource 来建立连接，DataSource 又需要从 Config 对象拿到用户名密码等信息。这就导致了创建这些对象是很复杂的，你要理清它们之间的依赖关系，哪个先创建哪个后创建。</span></aside><div id="mJJXD7M2HX1JcLnr78Wj9z" class="wolai-block wolai-text"><div><span class="inline-wrap">比如这样：</span></div><code-block id="5GdXVwHnDYM2oEuQKQakkp" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSource</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span>repository<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Controller</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre></div></code-block></div><div id="iuaiFd2bgdKBy866PsR1AK" class="wolai-block wolai-text"><div><span class="inline-wrap">要经过一系列的初始化之后才可以使用 Controller 对象。</span></div></div><div id="u77z8Qe3EJb6QiVycuXfkV" class="wolai-block wolai-text"><div><span class="inline-wrap">而且像 config、dataSource、repository、service、controller 等这些对象不需要每次都 new 一个新的，一直用一个就可以，也就是保持</span><span class="inline-wrap"><b>单例</b></span><span class="inline-wrap">。</span></div></div><div id="riDSpGzpqeENt9pswZKrr9" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="sosGqXqUQqjSKb8quJs8Pz" class="wolai-block wolai-text"><div><span class="inline-wrap">在应用初始化的时候，需要理清依赖的先后关系，创建一大堆对象组合起来，还要保证不要多次 new，这是一个后端系统都有的痛点问题。</span></div></div><div id="aLRwWVv9nFBq2ZCbBJyGH7" class="wolai-block wolai-text"><div><span class="inline-wrap">Java 的 Spring 就实现了 IOC，Nest 也同样实现了。</span></div></div><div id="wansCxdgVzALuiYGjFvEA" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h2 id="5UBeo4aS2uoo4e3gsJmwdP" class="wolai-block"><span class="inline-wrap">控制反转</span></h2><div id="qyhoJBtKnCmifVet38LMH4" class="wolai-block wolai-text"><div><span class="inline-wrap">自己手动创建和组装对象很麻烦，因此<span class="jill"></span>nest<span class="jill"></span>帮我们做了这一点，使用者只需要根据<span class="jill"></span>nest<span class="jill"></span>提供的标准，声明好哪些依赖关系，便可以完成</span><span class="inline-wrap"><b>自动化对象创建和组装</b></span><span class="inline-wrap">。从主动创建依赖到被动等待依赖注入，这就是 Inverse Of Control，反转控制。</span></div></div><div id="ji5DY7exPBqiL44o7UXfek" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="x2kh439x5pFaqqkBZR33A7" class="wolai-block wolai-text"><div><span class="inline-wrap">还是简单看一下代码：</span></div></div><code-block id="7zdAgvFDnFFJpiH8mkuLnp" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token comment">// src/main.ts文件</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">NestFactory</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// src/app.module.ts文件</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span> 

@<span class="token function"><span class="token maybe-class-name">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 <span class="token literal-property property">imports</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token literal-property property">controllers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token literal-property property">providers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 
 
 <span class="token comment">// src/app.service.ts文件</span>
 <span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

 @<span class="token function"><span class="token maybe-class-name">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">AppService</span> <span class="token punctuation">{</span>
   <span class="token function">getHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
     <span class="token keyword control-flow">return</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 
 
 <span class="token comment">// src/app.controller.ts文件</span>
 <span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Controller</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Get</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
 <span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>

 @<span class="token function"><span class="token maybe-class-name">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">AppController</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> readonly appService<span class="token operator">:</span> <span class="token maybe-class-name">AppService</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

   @<span class="token function"><span class="token maybe-class-name">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">getHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
     <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">appService</span><span class="token punctuation">.</span><span class="token method function property-access">getHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</pre></div></code-block><div id="dtzoLTTecEzcdZZgNGxA6F" class="wolai-block wolai-text"><div><span class="inline-wrap">现在访问 </span><span class="inline-wrap"><code>localhost:3000</code></span><span class="inline-wrap"> 就会执行这个 AppController 类中的 </span><span class="inline-wrap"><code>getHello</code></span><span class="inline-wrap"> 方法了。我们来看 app.controller.ts 文件。可以看到构造函数的参数签名中第一个参数 appService 是 AppService 的一个实例。</span></div><div id="nV1CkYmCFeE8Hp4Pd9Ej2r" class="wolai-block wolai-text"><div><span class="inline-wrap"><code>constructor(private readonly appService: AppService){}</code></span></div></div></div><div id="bgmoCkDxzmHaDovsiF5YGu" class="wolai-block wolai-text"><div><span class="inline-wrap">但是在代码里并有没有看到实例化这个 AppService 的地方。这里其实是把创建这个实例对象的工作交给了<span class="jill"></span>nest<span class="jill"></span>框架，而不是 AppController 自己来创建这个对象，这就是所谓的</span><span class="inline-wrap"><code>控制反转</code></span><span class="inline-wrap">。而把创建好的 AppService 实例对象作为 AppController 实例化时的参数传给构造器就是</span><span class="inline-wrap"><code>依赖注入</code></span><span class="inline-wrap">了。</span></div></div><div id="2fDT5A8bBsT2KFf72Rcf5Y" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h2 id="3GjcC2HYdCxgLWWGPTBjMv" class="wolai-block"><span class="inline-wrap">面向切面</span></h2><div id="dFht1Z4LUXYGz1VdAUW2vg" class="wolai-block wolai-text"><div><span class="inline-wrap">后端框架基本都是 MVC 的架构。MVC 是 Model View Controller 的简写。</span></div></div><div id="gMAPnLDCRQZqi14FYU6yfM" class="wolai-block wolai-text"><div><span class="inline-wrap">MVC 架构下，请求会先发送给 Controller，由它调度 Model 层的 Service 来完成业务逻辑，然后返回对应的 View。</span></div></div><div id="m2LbcbaZD9VKFeDKFotJt8" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_2.png" style="width: 323px"/></figure></div><div id="oFRBAv2FKzJqeeY7BUqxrY" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="snQZktVCwfPXALdD3KQZM3" class="wolai-block wolai-text"><div><span class="inline-wrap">通常一个请求过来，可能会经过 Controller（控制器）、Service（服务）、Repository（数据库访问） ：</span></div></div><div id="n9ceDUNpWAyfFXWaSWf9Ns" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_3.png" style="width: 287px"/></figure></div><div id="geQMz9x42E7rSJxTNCZHVR" class="wolai-block wolai-text"><div><span class="inline-wrap">如果想在这个调用链路里加入一些通用逻辑呢？比如日志记录、权限控制、异常处理等。容易想到的是直接改造 Controller 层代码，加入这段逻辑。</span></div></div><div id="h8j4nbkQEeqzAj9TtDy5AL" class="wolai-block wolai-text"><div><span class="inline-wrap">可以是可以，但是不优雅，因为这些通用的逻辑侵入到了业务逻辑里面，形成了耦合。那如何进行不侵入性的操作呢？</span></div></div><div id="eYyPRLuw7uz6kS8p1K6Bx5" class="wolai-block wolai-text"><div><span class="inline-wrap">是不是可以在调用 Controller 前后加入一个执行通用逻辑的阶段？</span></div></div><div id="4CBKnojG9LQv2aEWYVXjq9" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_4.png" style="width: 412px"/></figure></div><div id="qKhwqHmMUUgXnURkNSKBQc" class="wolai-block wolai-text"><div><span class="inline-wrap">这样的横向扩展点就叫做切面，这种非侵入式的加入一些切面逻辑的编程方式就叫做 AOP （面向切面编程）。</span></div></div><aside id="iyxcwfctwupDZiSPYcPvyJ" class="bg-cultured wolai-block"><div data-symbol="📌" class="icon"></div><span class="inline-wrap">AOP 主要的思想是将我们对于业务逻辑无关的一些操作，比如日志记录、性能统计、安全控制、异常处理、错误上报等，将这些操作从业务逻辑中剥离出来，将它们放在一些独立的方法中，然后如果我们对这些操作做修改的时候就可以不用影响到业务逻辑相关的代码。它主要体现了我们对代码的低耦合性的追求。</span></aside><div id="5qRYX3xkNAFLFzKxrEfEDV" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 id="tik6TfN5zWdMWnCFLtN8FH" class="wolai-block"><span class="inline-wrap">Express<span class="jill"></span>中的<span class="jill"></span>AOP</span></h3><div id="drnUWLTbp67nNyf2ZbPNZD" class="wolai-block wolai-text"><div><span class="inline-wrap">在说<span class="jill"></span>Nest<span class="jill"></span>之前，先来看看<span class="jill"></span>Express<span class="jill"></span>中的中间件，其洋葱模型也是一种 AOP 的实现，因为你可以透明的在外面包一层，加入一些逻辑，内层感知不到。</span></div></div><div id="chxh8VDWSvcWY5CJoyzZEm" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_5.png" style="width: 418px"/></figure></div><div id="qHpcNwX86Z54bDJGko9dAR" class="wolai-block wolai-text"><div><span class="inline-wrap">在中间件函数中，可以执行以下任何任务</span></div></div><ul class="wolai-block"><li id="eTPyjixVjwt6NyE754fiUj"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">执行任何代码</span></li><li id="gimMBiKXhKYwraQHvHTGL3"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">修改 </span><span class="inline-wrap"><code>request</code></span><span class="inline-wrap"> 或 </span><span class="inline-wrap"><code>response</code></span><span class="inline-wrap"> 响应对象【同一个生命周期】</span></li><li id="k849TgVE2VfQaMM4HCWNce"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">结束请求响应周期</span></li><li id="uet47fxEotBYacLY7tkbjj"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">调用下一个中间件</span></li></ul><div id="592UL1AzoonKNQTzDwRukQ" class="wolai-block wolai-text"><div><span class="inline-wrap">简单看看<span class="jill"></span>Express<span class="jill"></span>的中间件的使用：</span></div></div><code-block id="55d8AGTu2KrcnTh3CDycMT" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token comment">// 洋葱模型</span>
<span class="token comment">// 全局使用中间件</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'全局中间件 start'</span><span class="token punctuation">)</span>
  <span class="token comment">// 调用下一个中间件</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'全局中间件 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 单独中间件</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>
  <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"单独中间件 start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"单独中间件 end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"处理请求 start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">"get method!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"处理请求 end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 运行结果</span>
<span class="token comment">// 全局中间件 start</span>
<span class="token comment">// 单独中间件 start</span>
<span class="token comment">// 处理请求 start</span>
<span class="token comment">// 处理请求 end</span>
<span class="token comment">// 单独中间件 end</span>
<span class="token comment">// 全局中间件 end</span>
</pre></div></code-block><div id="qkATGmmtjSiHW2m3RxXaWs" class="wolai-block wolai-text"><div><span class="inline-wrap">可以看到它的执行机制，以<span class="jill"></span>next()方法为分水岭，先执行所有中间件的<span class="jill"></span>next()方法前半部分，然后从后往前执行中间件<span class="jill"></span>next()方法的下半部分。这就是著名的洋葱模型。</span></div></div><div id="fZXgaR1NFHxSwJvXXqBaU5" class="wolai-block wolai-text"><div><span class="inline-wrap">可以简化为：</span></div></div><code-block id="x2yggnv9R2kzrbZXU6goi6" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre>app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>globalMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"route"</span><span class="token punctuation">,</span> middleware1<span class="token punctuation">,</span> middlewar2<span class="token punctuation">,</span> <span class="token spread operator">...</span><span class="token punctuation">,</span> mainMethod<span class="token punctuation">)</span>
</pre></div></code-block><div id="qADE4bJoUou3MRaocciyd7" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 id="3JsczvbY7yJn2sBjR5pwfz" class="wolai-block"><span class="inline-wrap">Nest<span class="jill"></span>中的<span class="jill"></span>AOP</span></h3><div id="g8zGsCkUC3ikqn3NwfMQQh" class="wolai-block wolai-text"><div><span class="inline-wrap">Nest 实现 AOP 的方式更多，一共有五种，包括 Middleware、Guard、Pipe、Interceptor、ExceptionFilter。</span></div></div><div id="aKWyXpt9WFzepz8n3ykCKt" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 id="pVfQ4QQEdppMfKeG6stair" class="wolai-block"><span class="inline-wrap">中间件 Middleware</span></h4><div id="sQnUx46rHZMfTNymHwFZ1E" class="wolai-block wolai-text"><div><span class="inline-wrap">Nest 的底层是<span class="jill"></span>Express，所以也有中间件 Middleware 的概念，它和 Express 的 Middleware 很像，但不完全一样。</span></div></div><div id="brS8GS6yeu6TkBaZyx5iR1" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="93y7HbdpchqTEMDBqoQ4h4" class="wolai-block wolai-text"><div><span class="inline-wrap">举个例子，我们首先创建了一个中间件</span><span class="inline-wrap"><code>AppMiddleware</code></span><span class="inline-wrap"> ，:</span></div></div><code-block id="krSYNxGrVnJvcyn3CoqBmv" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NestMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Response</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

@<span class="token function"><span class="token maybe-class-name">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">AppMiddleware</span> <span class="token keyword">implements</span> <span class="token class-name">NestMiddleware</span> <span class="token punctuation">{</span>
  <span class="token function">use</span><span class="token punctuation">(</span>req<span class="token operator">:</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token literal-property property">res</span><span class="token operator">:</span> <span class="token maybe-class-name">Response</span><span class="token punctuation">,</span> <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'brefore'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'after'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="s5nqDt2oPxR8Lao3HdqtMv" class="wolai-block wolai-text"><div><span class="inline-wrap">然后在<span class="jill"></span>AppModule<span class="jill"></span>中使用这个中间件：</span></div></div><code-block id="kYTyCGxiBTauJPTvk3uHTb" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'. /app.middleware'</span><span class="token punctuation">;</span> 
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MiddlewareConsumer</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Module</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NestModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span> 
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'. /app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'. /app.service'</span><span class="token punctuation">;</span>

@<span class="token function"><span class="token maybe-class-name">Module</span></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">imports</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">controllers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">providers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppServicel</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token keyword">implements</span> <span class="token class-name">NestModule</span> <span class="token punctuation">{</span>
  <span class="token function">configure</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">consumer</span><span class="token operator">:</span> <span class="token maybe-class-name">MiddlewareConsumer</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consumer<span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppMiddleware</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="gFwXqGMN49Bk4kPZmVnHzy" class="wolai-block wolai-text"><div><span class="inline-wrap">实现 NestModule 接口的 </span><span class="inline-wrap"><code>configure</code></span><span class="inline-wrap"> 方法，在里面应用 AppMiddleware 到</span><span class="inline-wrap"><b>所有路由</b></span><span class="inline-wrap">。这里的</span><span class="inline-wrap"><code>*</code></span><span class="inline-wrap">也可以修改为</span><span class="inline-wrap"><code>{ path: &#39;route&#39;, method: RequestMethod.GET }</code></span><span class="inline-wrap">指定具体的路由应用具体的中间件。</span></div></div><div id="vpU3iB5GV523F7Fzk2HQh8" class="wolai-block wolai-text"><div><span class="inline-wrap">到这里与<span class="jill"></span>Express<span class="jill"></span>中间件还是蛮一样的，只是将中间件从</span><span class="inline-wrap"><code>function</code></span><span class="inline-wrap">变成了</span><span class="inline-wrap"><code>class</code></span><span class="inline-wrap">的形式 ；</span></div></div><div id="oEbzEWsp6BbfqW7LQ47tdf" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><aside id="iqmZTbNkeSm25vz28iouwy" class="bg-cultured wolai-block"><div data-symbol="📌" class="icon"></div><span class="inline-wrap">Nest 为什么要把 Middleware 做成 class 有什么好处呢？</span></aside><div id="q4MhBmsh4UnRHcGgCMSXWx" class="wolai-block wolai-text"><div><span class="inline-wrap">好处就是可以使用</span><span class="inline-wrap"><b>依赖注入</b></span><span class="inline-wrap">。</span></div></div><div id="SkrfCihGPvBEHMT2zhfT6" class="wolai-block wolai-text"><div><span class="inline-wrap">我们通过 </span><span class="inline-wrap"><code>@Inject</code></span><span class="inline-wrap"> 或者构造器 将 AppService 注入到 middleware 里：</span></div></div><code-block id="Mb88VUGHYySXRre713nMr" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Inject</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NestMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Response</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

@<span class="token function"><span class="token maybe-class-name">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">AppMiddleware</span> <span class="token keyword">implements</span> <span class="token class-name">NestMiddleware</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> readonly appService<span class="token operator">:</span> <span class="token maybe-class-name">AppService</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// @Inject (AppService)</span>
  <span class="token comment">// private readonly appService: AppService;</span>
  
  <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">req</span><span class="token operator">:</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token literal-property property">res</span><span class="token operator">:</span> <span class="token maybe-class-name">Response</span><span class="token punctuation">,</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token known-class-name class-name">Function</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do some...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">appService</span><span class="token punctuation">.</span><span class="token method function property-access">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Request...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="79339MdmLYni98Q5v4RuzP" class="wolai-block wolai-text"><div><span class="inline-wrap">当访问这个路由的时候，中间件里便会调用了 AppService<span class="jill"></span>中的<span class="jill"></span>method<span class="jill"></span>方法。</span></div></div><div id="bUVPxv3aBn2PpF1Ws25Rew" class="wolai-block wolai-text"><div><span class="inline-wrap">举例一个场景：</span></div><div id="319myMkRg3DEQYsJnVeLdE" class="wolai-block wolai-text"><div><span class="inline-wrap">假设我们有一个应用程序，需要对所有传入的请求进行安全检查，以防止被 XSS（跨站点脚本攻击）或 CSRF（跨站点请求伪造）等攻击。我们可以实现一个 </span><span class="inline-wrap"><code>SecurityMiddleware</code></span><span class="inline-wrap"> 中间件来处理这些安全问题，并将 </span><span class="inline-wrap"><code>SecurityService</code></span><span class="inline-wrap"> 通过依赖注入的方式注入到 </span><span class="inline-wrap"><code>SecurityMiddleware 中</code></span><span class="inline-wrap">，代码如下所示：</span></div></div><code-block id="dBH9CfV6UGVBTsdXuV1BT7" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NestMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Response</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SecurityService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./security.service'</span><span class="token punctuation">;</span>

@<span class="token function"><span class="token maybe-class-name">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">SecurityMiddleware</span> <span class="token keyword">implements</span> <span class="token class-name">NestMiddleware</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> readonly securityService<span class="token operator">:</span> <span class="token maybe-class-name">SecurityService</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">use</span><span class="token punctuation">(</span>req<span class="token operator">:</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token literal-property property">res</span><span class="token operator">:</span> <span class="token maybe-class-name">Response</span><span class="token punctuation">,</span> <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isXss <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">securityService</span><span class="token punctuation">.</span><span class="token method function property-access">checkXssAttack</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>isXss<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> res<span class="token punctuation">.</span><span class="token method function property-access">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'Invalid request data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> isCsrf <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">securityService</span><span class="token punctuation">.</span><span class="token method function property-access">checkCsrfAttack</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token property-access">cookies</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token property-access">headers</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>isCsrf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> res<span class="token punctuation">.</span><span class="token method function property-access">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'CSRF attack detected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block></div><div id="dsz9K2ytgdkuW1uw7QQ99g" class="wolai-block wolai-text"><div><span class="inline-wrap">然后将 SecurityMiddleware 注册到应用程序中。代码如下所示：</span></div></div><div id="vafTpS1XcJdj3KgXhxymSB" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><code-block id="4E9fgFP8FqMGHbNFJdwqPd" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MiddlewareConsumer</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Module</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NestModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SecurityMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./security.middleware'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SecurityService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./security.service'</span><span class="token punctuation">;</span>
@<span class="token function"><span class="token maybe-class-name">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">imports</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">controllers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">providers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppService</span><span class="token punctuation">,</span> <span class="token maybe-class-name">SecurityService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token keyword">implements</span> <span class="token class-name">NestModule</span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">consumer</span><span class="token operator">:</span> <span class="token maybe-class-name">MiddlewareConsumer</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consumer<span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token maybe-class-name">SecurityMiddleware</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>` 
</pre></div></code-block><div id="ocv3qXAbgu8WHUCTZ7ReUS" class="wolai-block wolai-text"><div><span class="inline-wrap">在上面的代码中，我们通过 </span><span class="inline-wrap"><code>consumer.apply(SecurityMiddleware).forRoutes(&#39;*&#39;)</code></span><span class="inline-wrap"> 将 SecurityMiddleware 注册到了应用程序的所有路由中。这样，在访问任何路由时，都会自动触发 SecurityMiddleware 进行安全检查。</span></div></div><div id="ane173KGSUBNpzTE8wLTka" class="wolai-block wolai-text"><div><span class="inline-wrap">这就是 Nest 注入的依赖。</span></div></div><blockquote id="aVGvTEJvULnGf2kdNuQpPm" class="wolai-block"><span class="gray inline-wrap">如果不需要注入依赖，那可以写函数形式的 middleware，这时候和 Express 的 middleware 就没啥区别了。</span></blockquote><div id="w5GdNxNLqoYySPLtrDxy9H" class="wolai-block wolai-text"><div><span class="inline-wrap">其他实现<span class="jill"></span>AOP<span class="jill"></span>的方式（ Guard、Pipe、Interceptor、ExceptionFilter）其实与中间件类似，只是实现不同的接口的不同方法：</span></div></div><details id="cwAURA6MrXmnTFtev1Krsa" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">Guard：实现<span class="jill"></span>CanActivate 接口的<span class="jill"></span>canActivate<span class="jill"></span>方法，返回 true、false 来表示是否继续。</span></summary><div id="cQ6rDizwGedPgizgcw1qEg" class="wolai-block wolai-text"><div><span class="inline-wrap"><code>@UseGuards(XxxGuard)</code></span></div></div><div id="mx3yNUgTjPwkj44s3SCTD7" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_6.png" style="width: 708px"/></figure></div></details><details id="ty6bnFmU721NJXL5vEfAe9" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">Pipe：实现<span class="jill"></span>PipeTransform<span class="jill"></span>接口的<span class="jill"></span>transform<span class="jill"></span>方法，对传入<span class="jill"></span>Controller<span class="jill"></span>的参数做验证或转换，也可抛出异常。</span></summary><div id="rCh6UprP7WiiBDCFNzQYw3" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_7.png" style="width: 714px"/></figure></div></details><details id="9T9YPz9Qhe33mKNnjdbiw6" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">Interceptor：实现<span class="jill"></span>NestInterceptor<span class="jill"></span>接口的<span class="jill"></span>intercepe<span class="jill"></span>方法，可以对请求前后加入一些逻辑。</span></summary><div id="4MogBtmj4Asrt2aYK3f8xq" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_8.png" style="width: 712px"/></figure></div></details><details id="harMnRctrHcAqu626MQMHd" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">ExceptionFilter： 实现<span class="jill"></span>ExceptionFilter<span class="jill"></span>接口的<span class="jill"></span>catch<span class="jill"></span>方法，捕捉异常，返回友好信息给客户端。</span></summary><div id="9DyHG9JTqerrFhmvYocvJA" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_9.png" style="width: 709px"/></figure></div></details><div id="as1ffYuriThjPHSSEYQquQ" class="wolai-block wolai-text"><div><span class="inline-wrap">但本质上都是通用逻辑的抽离封装。整个请求生命周期大概是：</span></div></div><div id="fh6NtkEgMgLu3NWmvsumVU" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="nz2KpTfHxbyAr4JUJXrjNW" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_10.png" style="width: 100%"/></figure></div><ul class="wolai-block"><li id="3jLEiggq1DpvhAYjPAPdyd"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">首先，请求会被 middleware 处理，这一层可以复用 express 的中间件生态，也可以是 Nest 的那种 class 的 middleware，可以注入 provider。</span></li><li id="eD1GUTUVMyvawmCJHjdZjj"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">然后在具体的路由会经历 Guard 的处理，可以实现权限验证等功能。</span></li><li id="6SSzNF2Gj2vjPPTa59Vt47"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">之后是 Interceptor 可以在请求前后做一些处理</span></li><li id="cJ3YNBNycMw9UbJw39Q4GU"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">在到达 handler（controller） 之前，还会对参数用 Pipe 做下检验和转换。</span></li><li id="xqTc2Jsw2y6bP2LpPJaCLH"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">这个过程中不管是哪一层抛的异常，都会被 Exception Filter 处理下，返回给用户友好的响应信息。</span></li></ul><div id="t8DC7f5MAQwTuGYSDjCLud" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h2 id="7Cqkthj9YozrFCm5cVEvsU" class="wolai-block"><span class="inline-wrap">跨平台</span></h2><div id="mLxJERKka3GB9kJ6hnpBLk" class="wolai-block wolai-text"><div><span class="inline-wrap">前面说，Nest 的底层平台是 Express，其实并不准确，Nest 并没有和 Express 耦合。</span></div></div><div id="iTyXDC7S2k6fj5Jxx5sZf2" class="wolai-block wolai-text"><div><span class="inline-wrap">它所有的上层代码都是基于一个抽象的接口的，而这个接口有 Express 和 Fastify 两种实现，默认是<span class="jill"></span>Express，即使有一天，有一个新的 http 库取代了 express，对 nest 也没有什么影响，只要加一个新平台的适配器就可以了。</span></div></div><div id="u8RfABvNaUff8Nkt3DmD1m" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_11.png" style="width: 100%"/></figure></div><div id="aKPxCn4rmrTUQkx7ryVnHF" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_12.png" style="width: 782px"/></figure></div><div id="mbMkYrTEVoDAens2QC1uxd" class="wolai-block wolai-text"><div><span class="inline-wrap">不只是 http<span class="jill"></span>服务 可以切换具体的底层平台，websocket 也是，可以切换 socket.io 和 ws：</span></div></div><div id="73Kk77P6vUM6fgEvwVf3Zk" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_13.png" style="width: 100%"/></figure></div><div id="eFCgnCtXFcEwjwWEWocTY7" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="KpZXyTD1asWtLo7LztRAt" class="wolai-block wolai-text"><div><span class="inline-wrap">另外，Nest 支持创建 HTTP 服务、WebSocket 服务，还有基于 TCP 通信的微服务。</span></div></div><div id="4n6Hgftnj19CUaEDvNZvxM" class="wolai-block wolai-text"><div><span class="inline-wrap">你写的一些 Guard、Exception Filter、Interceptor、Pipe 也可以用在 Websocket 和微服务里，</span></div></div><div id="fcPLZz4DtTenowpmnAfRiE" class="wolai-block wolai-text"><div><span class="inline-wrap">Nest<span class="jill"></span>提供了 </span><span class="inline-wrap"><code>ArgumentsHost</code></span><span class="inline-wrap"> 类，在切面里拿到它之后，可以判断出当前是什么上下文：</span></div></div><div id="8baGmiveCvxNZXiRbPYQ9H" class="wolai-block wolai-text"><div><span class="inline-wrap">比如：</span></div></div><code-block id="K16BkBaAY4SW8gKBGHZeh" class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ArgumentsHost</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Catch</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ExceptionFilter</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Response</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CustomerException</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./CustomerException'</span><span class="token punctuation">;</span>

@<span class="token function"><span class="token maybe-class-name">Catch</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">CustomerException</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">CustomerFilter</span> <span class="token keyword">implements</span> <span class="token class-name">ExceptionFilter</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>exception<span class="token operator">:</span> <span class="token maybe-class-name">CustomerException</span><span class="token punctuation">,</span> <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token maybe-class-name">ArgumentsHost</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>host<span class="token punctuation">.</span><span class="token method function property-access">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'http'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token method function property-access">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> response <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token property-access">getResponse</span><span class="token operator">&lt;</span><span class="token maybe-class-name">Response</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> request <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token property-access">getRequest</span><span class="token operator">&lt;</span><span class="token maybe-class-name">Request</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      response
        <span class="token punctuation">.</span><span class="token method function property-access">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">aaa</span><span class="token operator">:</span> exception<span class="token punctuation">.</span><span class="token property-access">aaa</span><span class="token punctuation">,</span>
          <span class="token literal-property property">bbb</span><span class="token operator">:</span> exception<span class="token punctuation">.</span><span class="token property-access">bbb</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>host<span class="token punctuation">.</span><span class="token method function property-access">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'ws'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token method function property-access">switchToWs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>host<span class="token punctuation">.</span><span class="token method function property-access">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'rpc'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token method function property-access">swtichToRpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="826rziBDy275T4yXZmz7AW" class="wolai-block wolai-text"><div><span class="inline-wrap">这样就实现了切面的跨上下文复用。</span></div></div><div id="4ZKKPVqX7jTapmPQzn2Jy9" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h1 id="dX21ftTSei5ZP4YtpDC977" class="wolai-block"><span class="inline-wrap">总结</span></h1><div id="LBT8MH1rkr2zSzs8EYFT2" class="wolai-block wolai-text"><div><span class="inline-wrap">Nest 是在 express 之上封装的一层，提供了很多架构的能力：</span></div></div><ul class="wolai-block"><li id="e3Aumfx8zqZjgJF5xLQkMD"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>IOC</b></span><span class="inline-wrap">：自己实现了模块机制，可以导入导出 provider，实现自动依赖注入，简化了对象的创建</span></li><li id="8y9hbYMJpBAUfowDAjnLp"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>AOP</b></span><span class="inline-wrap">：抽象了 Middleware、Guard、Interceptor、Pipe、Exception Filter 这 5 种切面，可以通过切面抽离一些通用逻辑，然后动态添加到某个流程中。</span></li><li id="7v4YvPtRoGfc9mqtMiEdgh"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">跨平台：Nest 基于 ts 的 interface 实现了不和任何底层平台耦合，http 可以切换 express 和 fastify，websocket 可以切换 socket.io 和 ws。而且 5 种切面也实现了可以跨 http、websocket、微服务来复用。</span></li></ul><div id="egkP56EnesGm3UpXu4ACsX" class="wolai-block wolai-text"><div><span class="inline-wrap">有了这三种架构特性，代码自然会变得松散耦合、易于扩展，易于维护。</span></div></div><div id="pxyotxac3Chfd5xSTWEv6g" class="wolai-block wolai-text"><div></div></div></article><footer></footer></body></html>